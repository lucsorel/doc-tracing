:revealjs_customtheme: assets/doc-tracing.css
:revealjs_progress: true
:revealjs_slideNumber: true
:source-highlighter: highlightjs
:icons: font
:toc:

= Doc-tracing

== Tra√ßage d'ex√©cution du code √† des fins documentaires

Outiller les discussions d'architecture avec des diagrammes d'ex√©cution des tests fonctionnels.


[.small]
*Luc Sorel-Giffo* -- jeudi 6 avril 2023 -- Soir√©e des communaut√©s techniques rennaises

[.small]
https://floss.social/@lucsorelgiffo[@lucsorelgiffo@floss.social]

=== Gen√®se de l'id√©e : du doc-as-code ++

* documenter une base de code, c'est bien
* √©crire de la documentation, c'est p√©nible / _improductif_
* maintenir de la documentation, c'est... rarement fait

üéâ `doc-as-code` :

* üéì √©crire la doc comme on √©crit du code (fichiers _texte_, DSL)
* üí° g√©n√©rer la doc √† partir du code !

[.columns]
=== Il y a 2 types de code dans le doc-as-code

[.column]
--

[.small]
Le code source (v√©rit√©)

[source,python]
----
# school.py
from dataclasses import \
    dataclass

@dataclass
class Person:
    firstname: str
    lastname: str

@dataclass
class Course:
    name: str
    teacher: Person

@dataclass
class Student(Person):
    courses: list[Course]
----
--

[.column]
--

[.small]
Le code de la doc (PlantUML, Asciidoc, etc.)

[source,java]
----
# school.puml
@startuml school
class school.Course {
  name: str
  teacher: Person
}
class school.Person {
  firstname: str
  lastname: str
}
class school.Student {
  courses: list[Course]
}
school.Course *-- school.Person
school.Student *-- school.Course
school.Person <|-- school.Student
footer Generated by //py2puml//
@enduml
----
--

[.column]
--

[.small]
(le code des outils de g√©n√©ration et de rendu de la doc) +

[plantuml, target=class-diagram, format=svg]
----
@startuml school
class school.Course {
  name: str
  teacher: Person
}
class school.Person {
  firstname: str
  lastname: str
}
class school.Student {
  courses: list[Course]
}
school.Course *-- school.Person
school.Student *-- school.Course
school.Person <|-- school.Student
footer Generated by //py2puml//
@enduml
----
--

=== Doc-as-code par analyse statique de code - composants

Exemple d'une CLI proposant de calculer `factoriel(n)` ou `fibonacci(n)` :

[plantuml, target=component-diagram, format=svg]
----
@startuml math_cli
package math_cli {
  frame ~__main~__.py {
    component "math~_cli()"
    note bottom of "math~_cli()" : Cli entrypoint
    component "factorial(value: int)"
    component "fibonacci(value: int)"
  }

  frame factorial.py {
    component "factorial~_reduce(value: int) -> int" as FACTORIAL
    note bottom of FACTORIAL : Functional implementation of factorial
  }

  frame fibonacci.py {
    component "fibonacci~_recurse(value: int) -> int" as FIBONACCI
    note bottom of FIBONACCI : Recursive implementation of the Fibonacci suite
  }

  frame validation.py {
    component "validate~_positive~_int(value: int) -> int"
  }
}
@enduml
----

[.small]
Tous les exemples de code se trouvent dans https://github.com/lucsorel/doc-tracing/tree/main/examples/[github.com/lucsorel/doc-tracing/tree/main/examples].

=== Doc-as-code par analyse statique de code - pydoc

[source, python]
----
# math_cli/factorial.py
from functools import reduce

def factorial_reduce(value: int) -> int:
    '''Functional implementation of factorial'''
    if value == 1:
        return 1

    return reduce(lambda agg, index: agg * index, range(value, 1, -1), 1)
----

[source, sh]
----
python -m pydoc -p 8080 -b # -> http://localhost:8080
----

image::assets/pydoc-module-math_cli.factorial.png[pydoc_factorial, 60%]

[.notes]
--
Il existe plein d'outils dans tous les langages. Pour Python :
- https://github.com/NiklasRosenstein/pydoc-markdown
- https://pdoc3.github.io/pdoc/
- https://mkdocstrings.github.io/
- https://github.com/vemel/handsdown#-handsdown---python-documentation-generator
- https://pdoc.dev/
- https://github.com/davidenunes/mkgendocs#mkgendocs
- https://github.com/terrencepreilly/darglint#darglint
- https://github.com/PyCQA/pydocstyle/#pydocstyle---docstring-style-checker
- https://github.com/dadadel/pyment#pyment
- https://github.com/Carreau/velin#v%C3%A9lin
--

[.columns]
=== Apports et limites de l'analyse statique de code

[.column]
--
üôÇ

* code as doc : g√©n√©ration √† partir d'une source de v√©rit√©
* valorisation : docstring & annotations de typage
--

[.column]
--
üôÅ

* on sait o√π se trouvent les fonctions mais pas **la fa√ßon dont elles s'articulent**
* on ne voit pas **comment sont g√©r√©es les erreurs**
--

[.columns]
=== Tra√ßage d'ex√©cution

[.column]
--
[source, python]
----
from sys import argv

def factorial(n: int) -> int:
    assert n > 0
    if n == 1:
        return 1
    return n * factorial(n - 1)

factorial(int(argv[1]))
----
--

[.column]
--
[source, text]
----
python -m trace --trace trace_factorial.py 3

 --- modulename: trace_factorial, funcname: <module>
trace_factorial.py(1): from sys import argv
trace_factorial.py(3): def factorial(n: int) -> int:
trace_factorial.py(9): factorial(int(argv[1]))
 --- modulename: trace_factorial, funcname: factorial
trace_factorial.py(4):     assert n > 0
trace_factorial.py(5):     if n == 1:
trace_factorial.py(7):     return n * factorial(n - 1)
 --- modulename: trace_factorial, funcname: factorial
trace_factorial.py(4):     assert n > 0
trace_factorial.py(5):     if n == 1:
trace_factorial.py(7):     return n * factorial(n - 1)
 --- modulename: trace_factorial, funcname: factorial
trace_factorial.py(4):     assert n > 0
trace_factorial.py(5):     if n == 1:
trace_factorial.py(6):         return 1
----

_Et si on utilisait des regexp dessus pour faire un diagramme de s√©quence ‚∏Æ_ üòÅ
--

[.notes]
--
Plus d'infos sur cette fonctionnalit√© de tra√ßage (`python - trace` et `trace.Trace`) : https://docs.python.org/3/library/trace.html#module-trace
--

== Exploration de sys.settrace

Le module `sys` propose d'ajouter un hook avec https://docs.python.org/3/library/sys.html#sys.settrace[sys.settrace] qui va √™tre appel√© √† chaque √©tape d'ex√©cution du code :

[source, python]
----
from sys import gettrace, settrace

def trace_func(self, func: Callable, *args, **kwargs) -> Any:
    '''Applies the doc-tracer during the execution of the given func'''
    tracer = gettrace()

    settrace(global_doctracer)
    try:
        return func(*args, **kwargs)
    finally:
        settrace(tracer)
----

[.small]

=== Global tracer : appel d'un bloc de code

L'ex√©cution du code (script, fonction) doit-elle √™tre trac√©e ?

[source, python]
----
def global_tracer(frame, event: str, arg: Any) -> Callable:
    # ici : event vaut toujours 'call', arg est toujours None
    if should_trace_call(frame):
        # appel trac√©
        return local_tracer
    # return None -> appel non trac√©
----

.Doc officielle : https://docs.python.org/3/reference/datamodel.html#frame-objects[frame], https://docs.python.org/3/reference/datamodel.html#index-55[code]
[plantuml, target=class-diagram, format=svg]
----
@startuml frame
class frame {
  f_globals: dict # __name__, __module__, __file__, __doc__, etc.
  f_lineno: int # n¬∞ de la ligne dans le fichier
  f_locals: dict # param√®tres pass√©s √† la fonction
  f_code: code # code appel√©

  f_back: frame # frame pr√©c√©dente, origine de l'appel
}
class code {
  co_name: str # nom de fonction
  co_filename: str # chemin absolu
  co_firstlineno: int # n¬∞ de la ligne de d√©but du code
  co_varnames: tuple[str] # arguments et variables locales
  co_code: bytes # instructions C
}
frame *- code
note top of frame : informations dynamiques
note top of code : informations statiques
@enduml
----

=== Local tracer : ex√©cution d'un bloc de code

[source, python]
----
def local_tracer(frame, event: str, arg: Any) -> Callable:
    # ici : event peut valoir 'line', 'return' ou 'exception'
    if event == 'line':
        ... # arg : toujours None
    if event == 'return':
        ... # arg : la valeur renvoy√©e
    if event == 'exception':
        error_class, error, traceback = arg
        # üí° stocker l'erreur et sa ligne d'√©mission

        # poursuite du tra√ßage avec un traceur sp√©cifique
        return error_tracer

    # pour continuer √† tracer l'ex√©cution du bloc
    return local_tracer
----

=== Error tracer : gestion de l'erreur dans le bloc de code

Similaire √† `local_tracer` :

[source, python]
----
def error_tracer(self, frame, event: str, arg: Any):
    # ici : event peut valoir 'line', 'return' ou 'exception'

    if event == 'exception':
        # lev√©e d'une erreur (la m√™me, une autre qui la remplace ou l'enrobe)
        # üí° stocker l'erreur et sa ligne d'√©mission
        ...

    elif event == 'return':
        # si il y a une erreur stock√©e :
        # - si ligne de sortie "return" == ligne de lev√©e d'erreur : propagation de l'erreur
        # - sinon : l'erreur a √©t√© trait√©e dans un except, sortie du bloc avec `arg`
        # üí° d√©r√©f√©rencer l'erreur stock√©e

        # s'il n'y a plus d'erreur stock√©e : sortie du bloc de code

    return error_tracer
----

[.columns]
== pydoctrace 0.1.0 (7 f√©vrier 2023) üéâ


[.column]
--

[source, python]
----
from pydoctrace.doctrace import trace_to_puml

@trace_to_puml
def factorial_reduce(value: int) -> int:
    '''Functional implementation of factorial'''
    value = validate_positive_int(value)
    if value == 1:
        return 1

    return reduce(
      lambda agg, index: agg * index,
      range(value, 1, -1),
      1
    )
----

* https://github.com/lucsorel/pydoctrace[github.com/lucsorel/pydoctrace]
* d√©corateur -> diagramme de s√©quence https://plantuml.com/en/sequence-diagram[PlantUML]
--

[.column]
--
[plantuml, target=sequence-diagram, format=svg]
----
@startuml factorial.factorial_reduce
skinparam BoxPadding 10
skinparam ParticipantPadding 5
skinparam NoteBackgroundColor Cornsilk
skinparam NoteBorderColor Sienna
hide footbox

[o-> "factorial\nfactorial_reduce"
note right: line 34

"factorial\nfactorial_reduce" -> "factorial\n<lambda>" ++
note left: line 38
note right: line 38

return 4
note right: line 38
|||

"factorial\nfactorial_reduce" -> "factorial\n<lambda>" ++
note left: line 38
note right: line 38

return 12
note right: line 38
|||

"factorial\nfactorial_reduce" -> "factorial\n<lambda>" ++
note left: line 38
note right: line 38

return 24
note right: line 38
|||


[<-- "factorial\nfactorial_reduce": 24
note right: line 38

footer Generated by //pydoctrace//
@enduml
----
--

=== pydoctrace : factorial reduce

[source, sh]
----
python -m math_cli --factorial 3
----

[plantuml, target=sequence-diagram, format=svg]
----
@startuml __main__.factorial
skinparam BoxPadding 10
skinparam ParticipantPadding 5
skinparam NoteBackgroundColor Cornsilk
skinparam NoteBorderColor Sienna
hide footbox

[o-> "~__main~__\nfactorial"
note right: line 24

"~__main~__\nfactorial" -> "math_cli.factorial\nfactorial_reduce" ++
note left: line 27
note right: line 5

"math_cli.factorial\nfactorial_reduce" -> "math_cli.validation\nvalidate_positive_int" ++
note left: line 7
note right: line 1

return 3
note right: line 5
|||

"math_cli.factorial\nfactorial_reduce" -> "math_cli.factorial\n<lambda>" ++
note left: line 11
note right: line 11

return 3
note right: line 11
|||

"math_cli.factorial\nfactorial_reduce" -> "math_cli.factorial\n<lambda>" ++
note left: line 11
note right: line 11

return 6
note right: line 11
|||

return 6
note right: line 11
|||

[<-- "~__main~__\nfactorial": 
note right: line 30

footer Generated by //pydoctrace//
@enduml

----

=== pydoctrace : fibonacci

[source, sh]
----
python -m math_cli --fibonacci 2
----

[plantuml, target=sequence-diagram, format=svg]
----
@startuml __main__.fibonacci
skinparam BoxPadding 10
skinparam ParticipantPadding 5
skinparam NoteBackgroundColor Cornsilk
skinparam NoteBorderColor Sienna
hide footbox

[o-> "~__main~__\nfibonacci"
note right: line 18

"~__main~__\nfibonacci" -> "math_cli.validation\nvalidate_positive_int" ++
note left: line 20
note right: line 1

return 2
note right: line 5
|||

"~__main~__\nfibonacci" -> "math_cli.fibonacci\nfibonacci_recurse" ++
note left: line 21
note right: line 1

"math_cli.fibonacci\nfibonacci_recurse" -> "math_cli.fibonacci\nfibonacci_recurse" ++
note left: line 7
note right: line 1

return 1
note right: line 5
|||

"math_cli.fibonacci\nfibonacci_recurse" -> "math_cli.fibonacci\nfibonacci_recurse" ++
note left: line 7
note right: line 1

return 0
note right: line 5
|||

return 1
note right: line 7
|||

[<-- "~__main~__\nfibonacci": 
note right: line 22

footer Generated by //pydoctrace//
@enduml
----

=== pydoctrace : factorial reduce, handled error

[source, sh]
----
python -m math_cli --factorial -1
----

[plantuml, target=sequence-diagram, format=svg]
----
@startuml __main__.factorial
skinparam BoxPadding 10
skinparam ParticipantPadding 5
skinparam NoteBackgroundColor Cornsilk
skinparam NoteBorderColor Sienna
hide footbox

[o-> "~__main~__\nfactorial"
note right: line 24

"~__main~__\nfactorial" -> "math_cli.factorial\nfactorial_reduce" ++
note left: line 27
note right: line 5

"math_cli.factorial\nfactorial_reduce" -> "math_cli.validation\nvalidate_positive_int" ++
note left: line 7
note right: line 1

"math_cli.factorial\nfactorial_reduce" o<--x "math_cli.validation\nvalidate_positive_int": ""ValueError""\nValue must be a positive integer, got -1.
deactivate "math_cli.validation\nvalidate_positive_int"
note right: line 3
note left: line 7

"~__main~__\nfactorial" o<--x "math_cli.factorial\nfactorial_reduce": ""ValueError""\nValue must be a positive integer, got -1.
deactivate "math_cli.factorial\nfactorial_reduce"
note right: line 7
note left: line 27

[<-- "~__main~__\nfactorial": 
note right: line 30

footer Generated by //pydoctrace//
@enduml
----

=== pydoctrace : fibonacci, unhandled error

[source, sh]
----
python -m math_cli --fibonacci -1
----

[plantuml, target=sequence-diagram, format=svg]
----
@startuml __main__.fibonacci
skinparam BoxPadding 10
skinparam ParticipantPadding 5
skinparam NoteBackgroundColor Cornsilk
skinparam NoteBorderColor Sienna
hide footbox

[o-> "~__main~__\nfibonacci"
note right: line 18

"~__main~__\nfibonacci" -> "math_cli.validation\nvalidate_positive_int" ++
note left: line 20
note right: line 1

"~__main~__\nfibonacci" o<--x "math_cli.validation\nvalidate_positive_int": ""ValueError""\nValue must be a positive integer, got -1.
deactivate "math_cli.validation\nvalidate_positive_int"
note right: line 3
note left: line 20

[<-->x "~__main~__\nfibonacci": ""ValueError""\nValue must be a positive integer, got -1.
note right: line 20

footer Generated by //pydoctrace//
@enduml
----

== Conclusion - doc-tracing


* mise en ≈ìuvre :
** API hook des langages interpr√©t√©s
** agents pour langages compil√©s
* architecture & diagramme de s√©quence : le bon niveau ?

=== pydoctrace - pistes d'√©volutions

* grouper les fonctions par module, les modules par packages
* diagramme de composants avec les fl√®ches d'appels (+ concis)
* export mermaidjs ou structurizr ?
* personnaliser les diagrammes produits
** exclure des modules du tra√ßage (builtins, outils de tests)
** fichier de diagramme : destination, nommage (utilisation des valeurs des param√®tres ?)
** skinparams pour PlantUML

√Ä prioriser en fonction des besoins : √† vos issues et vos ‚≠ê sur https://github.com/lucsorel/pydoctrace[github.com/lucsorel/pydoctrace]

=== Python Rennes

Envie d'une pr√©sentation plus d√©taill√©e ?

.Pour rejoindre le slack : https://tinyurl.com/slack-pythonrennes
image::assets/python_rennes-communaut√©.png[communaut√© Python Rennes]

**Merci ! Des questions ?**

Pr√©sentation √† retrouver sur https://github.com/lucsorel/doc-tracing[github.com/lucsorel/doc-tracing]
